<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>jobmejob • Workplace</title>
<link rel="stylesheet" href="./styles.css">
<style>
.container{max-width:1100px;margin:0 auto;padding:18px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:820px){.row{grid-template-columns:1fr}}
.status{
font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
white-space:pre-wrap;background:#0b1020;color:#e6e6e6;padding:12px;border-radius:12px;overflow:auto;
}
.kpiRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.kpi{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid rgba(17,19,24,.14);border-radius:999px;font-size:12px;background:#fff}
.warn{border-color:#f1d2a8;background:#fff7ea}
</style>
</head>
<body>
<div class="container">

<div class="card">
<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
<div>
<div class="h1" style="margin:0;font-size:22px">jobmejob Workplace</div>
<div class="small">Internal interface. Requires admin token.</div>
</div>
<div class="actions">
<button class="btn" id="copyLog" type="button">Copy log</button>
</div>
</div>
</div>

<div class="card">
<div style="font-weight:950;margin-bottom:10px">1) Configuration</div>
<div class="row">
<div>
<label class="small" style="font-weight:850">API Base URL</label>
<input id="apiBase" type="text" placeholder="https://...workers.dev">
</div>
<div>
<label class="small" style="font-weight:850">Admin Token (x-admin-token)</label>
<input id="adminToken" type="password" placeholder="Paste token">
</div>
</div>
<div class="actions" style="margin-top:10px">
<button class="btn primary" id="saveConfig" type="button">Save config</button>
<button class="btn" id="clearConfig" type="button">Clear</button>
<button class="btn" id="healthCheck" type="button">Health check</button>
</div>
<div class="small">Saved only in this browser via localStorage.</div>
</div>

<div class="card warn">
<div style="font-weight:950;margin-bottom:10px">2) Customer</div>
<div class="row">
<div>
<label class="small" style="font-weight:850">Customer ID (UUID)</label>
<input id="customerId" type="text" placeholder="...">
</div>
<div>
<label class="small" style="font-weight:850">Customer Email</label>
<input id="customerEmail" type="email" placeholder="demo@...">
</div>
</div>

<div class="row" style="margin-top:12px">
<div>
<label class="small" style="font-weight:850">Default channel (Mark Applied)</label>
<select id="defaultChannel">
<option value="email_manual">email_manual (team)</option>
<option value="email_gmail">email_gmail (customer Gmail)</option>
<option value="career_portal">career_portal</option>
</select>
</div>
<div>
<label class="small" style="font-weight:850">Default From Email (optional)</label>
<input id="defaultFromEmail" type="email" placeholder="applications@jobmejob.com">
</div>
</div>

<div class="actions" style="margin-top:10px">
<button class="btn primary" id="findCustomer" type="button">Find customer by email</button>
<button class="btn" id="loadQueue" type="button">Load queue</button>
</div>

<div class="small" style="margin-top:6px">Find uses: /customers/search?email=…</div>
</div>

<div class="card">
<div style="font-weight:950;margin-bottom:10px">3) Job fetching</div>
<div class="actions">
<button class="btn cta" id="fetchJobs" type="button">Fetch jobs</button>
<button class="btn danger" id="forceFetch" type="button">Force fetch</button>
</div>
<div class="small" id="fetchSummary" style="margin-top:10px">—</div>
</div>

<div class="card">
<div style="font-weight:950;margin-bottom:10px">4) Status overview</div>
<div class="small" id="statusMeta">No customer selected.</div>
<div class="kpiRow" id="statusKpis" style="display:none"></div>
</div>

<div class="card">
<div style="font-weight:950;margin-bottom:10px">5) Job queue</div>
<div class="small" id="queueMeta">No data loaded yet.</div>
<div class="tableWrap" style="margin-top:10px">
<table>
<thead><tr><th>Title</th><th>Company</th><th>Location</th><th>Posted</th><th>Actions</th></tr></thead>
<tbody id="jobsTbody"></tbody>
</table>
</div>
</div>

<div class="card">
<div style="font-weight:950;margin-bottom:10px">Response log</div>
<div id="log" class="status">Ready.</div>
</div>

</div>

<script>
"use strict";
const $ = (id) => document.getElementById(id);

function setLog(obj){
$("log").textContent = (typeof obj==="string") ? obj : JSON.stringify(obj,null,2);
}
function appendLog(line){
const cur=$("log").textContent||"";
$("log").textContent = (cur ? cur+"\n\n" : "") + String(line);
}

function looksLikeEmail(email){
const s=String(email||"").trim();
return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
}
function escapeHtml(s){
return String(s??"")
.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
.replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}

function loadSaved(){
const saved=JSON.parse(localStorage.getItem("jobmejob_workplace")||"{}");
if(saved.apiBase) $("apiBase").value=saved.apiBase;
if(saved.token) $("adminToken").value=saved.token;
if(saved.customerId) $("customerId").value=saved.customerId;
if(saved.customerEmail) $("customerEmail").value=saved.customerEmail;
if(saved.defaultChannel) $("defaultChannel").value=saved.defaultChannel;
if(saved.defaultFromEmail) $("defaultFromEmail").value=saved.defaultFromEmail;
}

function saveNow(){
const data={
apiBase: ($("apiBase").value||"").trim().replace(/\/$/,""),
token: ($("adminToken").value||"").trim(),
customerId: ($("customerId").value||"").trim(),
customerEmail: ($("customerEmail").value||"").trim().toLowerCase(),
defaultChannel: ($("defaultChannel").value||"email_manual").trim(),
defaultFromEmail: ($("defaultFromEmail").value||"").trim()
};
localStorage.setItem("jobmejob_workplace", JSON.stringify(data));
setLog({ok:true,message:"Saved to localStorage (browser only)."});
}

function clearNow(){
localStorage.removeItem("jobmejob_workplace");
$("apiBase").value="";
$("adminToken").value="";
$("customerId").value="";
$("customerEmail").value="";
$("defaultChannel").value="email_manual";
$("defaultFromEmail").value="";
$("jobsTbody").innerHTML="";
$("queueMeta").textContent="No data loaded yet.";
$("statusMeta").textContent="No customer selected.";
$("statusKpis").innerHTML="";
$("statusKpis").style.display="none";
$("fetchSummary").textContent="—";
setLog("Cleared.");
}

function getConfig(){
const apiBase=($("apiBase").value||"").trim().replace(/\/$/,"");
const token=($("adminToken").value||"").trim();
if(!apiBase) throw new Error("Missing API Base URL");
if(!token) throw new Error("Missing Admin Token");
return {apiBase, token};
}
function authHeaders(token){ return {"x-admin-token":token,"Content-Type":"application/json"}; }

async function apiGet(path){
const {apiBase, token}=getConfig();
const res=await fetch(apiBase+path,{method:"GET",headers:authHeaders(token)});
const text=await res.text();
let data=null; try{data=text?JSON.parse(text):null;}catch{data={raw:text};}
if(!res.ok) throw new Error((data&&(data.error||data.details))?JSON.stringify(data):`HTTP ${res.status}: ${text}`);
return data;
}
async function apiPost(path, body){
const {apiBase, token}=getConfig();
const res=await fetch(apiBase+path,{method:"POST",headers:authHeaders(token),body:JSON.stringify(body||{})});
const text=await res.text();
let data=null; try{data=text?JSON.parse(text):null;}catch{data={raw:text};}
if(!res.ok) throw new Error((data&&(data.error||data.details))?JSON.stringify(data):`HTTP ${res.status}: ${text}`);
return data;
}

async function healthCheck(){
try{
const apiBase=($("apiBase").value||"").trim().replace(/\/$/,"");
if(!apiBase) throw new Error("Missing API Base URL");
const res=await fetch(apiBase+"/health");
const text=await res.text();
let data=null; try{data=text?JSON.parse(text):{raw:text};}catch{data={raw:text};}
setLog({ok:res.ok,status:res.status,data});
}catch(e){ setLog({error:"Health check failed",details:String(e)}); }
}

async function findCustomer(){
try{
const email=($("customerEmail").value||"").trim().toLowerCase();
if(!email) { alert("Enter customer email"); return; }
setLog({info:"Searching customer",email});
const res=await apiGet(`/customers/search?email=${encodeURIComponent(email)}`);
setLog(res);
if(!res.found){ alert("Customer not found."); return; }
$("customerId").value=res.customer.id;
saveNow();
await loadStatusSummary();
alert("Customer found.");
}catch(e){ setLog({error:"Find customer failed",details:String(e)}); }
}

function renderJobs(queue){
const tbody=$("jobsTbody");
tbody.innerHTML="";
const jobs=(queue&&queue.data)?queue.data:[];
$("queueMeta").textContent=`Loaded ${jobs.length} jobs. Customer: ${queue.customer_id||"-"}`;

for(const j of jobs){
const posted=j.posted_at?String(j.posted_at).slice(0,10):"-";
const loc=[j.city,j.country].filter(Boolean).join(", ")||"-";
const title=j.title||"-";
const company=j.company_name||"-";
const applyUrl=j.apply_url||"";
const jobId=j.id||"";

const tr=document.createElement("tr");
tr.innerHTML = `
<td>${escapeHtml(title)}</td>
<td>${escapeHtml(company)}</td>
<td>${escapeHtml(loc)}</td>
<td><span class="badge">${escapeHtml(posted)}</span></td>
<td></td>
`;
const td=tr.querySelector("td:last-child");

const open=document.createElement("button");
open.className="btn small";
open.textContent="Open";
open.onclick=()=>{ if(!applyUrl){alert("No apply_url");return;} window.open(applyUrl,"_blank"); };

const mark=document.createElement("button");
mark.className="btn small primary";
mark.textContent="Mark applied";
mark.onclick=async ()=>{
try{
const customerId=($("customerId").value||"").trim();
const customerEmail=($("customerEmail").value||"").trim().toLowerCase();
if(!customerId){alert("Enter Customer ID");return;}
if(!customerEmail){alert("Enter Customer Email");return;}
if(!jobId){alert("Missing job_id");return;}

const channel=($("defaultChannel").value||"email_manual").trim();
const fromEmail=($("defaultFromEmail").value||"").trim();
if(fromEmail && !looksLikeEmail(fromEmail)){ alert("From Email invalid."); return; }

const payload={
email: customerEmail,
full_name: "",
job_id: jobId,
status: "applied",
applied_by: "team",
notes: "",
application_channel: channel,
from_email: fromEmail || null
};
setLog({info:"Marking applied",payload});
const r=await apiPost("/applications/mark",payload);
setLog(r);
saveNow();
await loadQueue();
}catch(e){ setLog({error:"Mark applied failed",details:String(e)}); }
};

td.appendChild(open);
td.appendChild(document.createTextNode(" "));
td.appendChild(mark);
tbody.appendChild(tr);
}
}

function renderStatusSummary(data){
const meta=$("statusMeta");
const kpis=$("statusKpis");
if(!data||!data.ok){
meta.textContent="Failed to load status overview.";
kpis.innerHTML="";
kpis.style.display="none";
return;
}
const counts=data.counts||{};
const get=(k)=>Number(counts[k]||0);
meta.textContent=`Customer: ${data.customer_id} · Total tracked: ${Number(data.total||0)}`;
kpis.style.display="flex";
kpis.innerHTML =
`<div class="kpi">New <b>${get("new")}</b></div>
<div class="kpi">Applied <b>${get("applied")}</b></div>
<div class="kpi">Shortlisted <b>${get("shortlisted")}</b></div>
<div class="kpi">Skipped <b>${get("skipped")}</b></div>
<div class="kpi">Rejected <b>${get("rejected")}</b></div>`;
}

async function loadStatusSummary(){
try{
const customerId=($("customerId").value||"").trim();
if(!customerId){
$("statusMeta").textContent="No customer selected.";
$("statusKpis").style.display="none";
return;
}
$("statusMeta").textContent="Loading…";
const res=await apiGet(`/customers/${encodeURIComponent(customerId)}/applications/summary`);
renderStatusSummary(res);
}catch(e){
$("statusMeta").textContent="Failed to load status overview.";
$("statusKpis").style.display="none";
appendLog("Status summary error: "+String(e));
}
}

async function loadQueue(){
try{
const customerId=($("customerId").value||"").trim();
if(!customerId){ alert("Enter customer_id"); return; }
const res=await apiGet(`/customers/${encodeURIComponent(customerId)}/jobs/queue`);
setLog(res);
renderJobs(res);
await loadStatusSummary();
}catch(e){ setLog({error:"Load queue failed",details:String(e)}); }
}

async function fetchJobs(force=false){
try{
const customerId=($("customerId").value||"").trim();
if(!customerId){ alert("Enter customer_id"); return; }
$("fetchSummary").textContent="Fetching…";
const qs=force?"?force=true":"";
const res=await apiPost(`/customers/${encodeURIComponent(customerId)}/fetch-jobs${qs}`,{});
setLog(res);
const q=await apiGet(`/customers/${encodeURIComponent(customerId)}/jobs/queue`);
renderJobs(q);
await loadStatusSummary();
$("fetchSummary").textContent=`Last fetch: queued ${Number(res?.queued_count ?? res?.total_jobs_added ?? 0)} | queue now ${(q?.data||[]).length}`;
}catch(e){
setLog({error:"Fetch jobs failed",details:String(e)});
$("fetchSummary").textContent="Fetch failed: "+String(e);
}
}

$("saveConfig").onclick=saveNow;
$("clearConfig").onclick=clearNow;
$("healthCheck").onclick=healthCheck;
$("findCustomer").onclick=findCustomer;
$("loadQueue").onclick=loadQueue;
$("fetchJobs").onclick=()=>fetchJobs(false);
$("forceFetch").onclick=()=>fetchJobs(true);
$("copyLog").onclick=async ()=>{
try{ await navigator.clipboard.writeText($("log").textContent||""); alert("Log copied."); }
catch{ alert("Copy failed."); }
};

loadSaved();
loadStatusSummary();
</script>
</body>
</html>
