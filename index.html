<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>JobMeJob · Workplace</title>

<style>
body {
font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
margin: 0;
background: #f6f7fb;
color: #111;
}

.container {
max-width: 1100px;
margin: 0 auto;
padding: 18px;
}

.card {
background: #fff;
border-radius: 14px;
padding: 16px;
box-shadow: 0 10px 30px rgba(0,0,0,0.08);
margin-bottom: 14px;
}

h1 { margin: 0 0 6px; font-size: 22px; }
h2 { margin: 0 0 10px; font-size: 16px; }
h3 { margin: 0 0 8px; font-size: 14px; }

.small {
font-size: 12px;
opacity: .75;
}

.row {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 12px;
}

@media (max-width: 820px) {
.row { grid-template-columns: 1fr; }
}

label {
display: block;
font-size: 12px;
opacity: .75;
margin-bottom: 6px;
}

input, select {
width: 100%;
padding: 10px 12px;
border-radius: 10px;
border: 1px solid #ddd;
font-size: 14px;
background: #fff;
}

button {
border: 1px solid #ddd;
background: #fff;
padding: 10px 12px;
border-radius: 10px;
cursor: pointer;
font-weight: 650;
}

button:hover { background: #f2f2f2; }

.actions {
display: flex;
flex-wrap: wrap;
gap: 10px;
margin-top: 10px;
}

.status {
font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
white-space: pre-wrap;
background: #0b1020;
color: #e6e6e6;
padding: 12px;
border-radius: 12px;
overflow: auto;
font-size: 12px;
}

table {
width: 100%;
border-collapse: collapse;
}

th, td {
text-align: left;
padding: 10px 8px;
border-bottom: 1px solid #eee;
vertical-align: top;
font-size: 13px;
}

th {
opacity: .7;
font-size: 12px;
}

.badge {
display: inline-block;
padding: 4px 8px;
border: 1px solid #ddd;
border-radius: 999px;
font-size: 12px;
}

.kpiRow {
display: flex;
flex-wrap: wrap;
gap: 8px;
margin-top: 6px;
}

.kpi {
display: inline-flex;
gap: 6px;
align-items: center;
padding: 6px 10px;
border: 1px solid #ddd;
border-radius: 999px;
font-size: 12px;
}
</style>
</head>

<body>
<div class="container">

<div class="card">
<h1>JobMeJob Workplace</h1>
<div class="small">
Internal team interface for managing customers, job queues, and application tracking.
Requires admin access. No customer-facing usage.
</div>
</div>

<div class="card">
<h2>1. Configuration</h2>
<div class="row">
<div>
<label>API Base URL</label>
<input id="apiBase" placeholder="https://api.jobmejob.com">
</div>
<div>
<label>Admin Token</label>
<input id="adminToken" type="password" placeholder="Paste admin token">
</div>
</div>

<div class="actions">
<button id="saveConfig">Save configuration</button>
<button id="clearConfig">Clear local config</button>
<button id="healthCheck">API health check</button>
</div>

<div class="small" style="margin-top:6px;">
Config is stored only in your browser (localStorage).
</div>
</div>

<div class="card">
<h2>2. Customer</h2>
<div class="row">
<div>
<label>Customer ID (UUID)</label>
<input id="customerId" placeholder="UUID">
</div>
<div>
<label>Customer Email</label>
<input id="customerEmail" placeholder="customer@email.com">
</div>
</div>

<div class="row" style="margin-top:12px;">
<div>
<label>Application Channel</label>
<select id="defaultChannel">
<option value="email_manual">email_manual (team)</option>
<option value="email_gmail">email_gmail (customer)</option>
<option value="career_portal">career_portal</option>
</select>
</div>
<div>
<label>From Email (optional)</label>
<input id="defaultFromEmail" placeholder="applications@jobmejob.com">
</div>
</div>

<div class="actions">
<button id="findCustomer">Find customer by email</button>
<button id="loadQueue">Load job queue</button>
</div>
</div>

<div class="card">
<h2>3. Job Fetching</h2>
<div class="actions">
<button id="fetchJobs">Fetch jobs (daily)</button>
<button id="forceFetch">Force fetch (testing only)</button>
</div>
<div class="small" style="margin-top:6px;">
Force fetch ignores daily protection. Use only for debugging.
</div>
<div class="small" id="fetchSummary" style="margin-top:6px;">—</div>
<div class="small" id="capHint">—</div>
</div>

<div class="card">
<h2>4. Status Overview</h2>
<div class="small" id="statusMeta">No customer selected.</div>
<div class="kpiRow" id="statusKpis" style="display:none"></div>
</div>

<div class="card">
<h2>5. Job Queue</h2>
<div class="small" id="queueMeta">No data loaded.</div>

<div style="overflow:auto; margin-top:10px;">
<table>
<thead>
<tr>
<th>Title</th>
<th>Company</th>
<th>Location</th>
<th>Posted</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="jobsTbody"></tbody>
</table>
</div>
</div>

<div class="card">
<h2>Response Log</h2>
<div id="log" class="status">Ready.</div>
</div>

</div>

<script>
const $ = id => document.getElementById(id);

function log(x){ $("log").textContent = typeof x === "string" ? x : JSON.stringify(x,null,2); }

function getCfg(){
return {
api: $("apiBase").value.trim().replace(/\/$/,""),
token: $("adminToken").value.trim()
};
}

function headers(){
return {
"x-admin-token": getCfg().token,
"Content-Type": "application/json"
};
}

function saveCfg(){
localStorage.setItem("jobmejob_workplace", JSON.stringify({
api: $("apiBase").value,
token: $("adminToken").value,
cid: $("customerId").value,
email: $("customerEmail").value,
channel: $("defaultChannel").value,
from: $("defaultFromEmail").value
}));
log("Configuration saved locally.");
}

function loadCfg(){
const d = JSON.parse(localStorage.getItem("jobmejob_workplace")||"{}");
if(d.api) $("apiBase").value=d.api;
if(d.token) $("adminToken").value=d.token;
if(d.cid) $("customerId").value=d.cid;
if(d.email) $("customerEmail").value=d.email;
if(d.channel) $("defaultChannel").value=d.channel;
if(d.from) $("defaultFromEmail").value=d.from;
}

function clearCfg(){
localStorage.removeItem("jobmejob_workplace");
location.reload();
}

async function apiGet(p){
const r=await fetch(getCfg().api+p,{headers:headers()});
const t=await r.text();
if(!r.ok) throw t;
return t?JSON.parse(t):{};
}

async function apiPost(p,b){
const r=await fetch(getCfg().api+p,{method:"POST",headers:headers(),body:JSON.stringify(b||{})});
const t=await r.text();
if(!r.ok) throw t;
return t?JSON.parse(t):{};
}

$("saveConfig").onclick=saveCfg;
$("clearConfig").onclick=clearCfg;

$("healthCheck").onclick=async()=>{
try{ log(await (await fetch(getCfg().api+"/health")).json()); }
catch(e){ log(e); }
};

$("findCustomer").onclick=async()=>{
try{
const r=await apiGet("/customers/search?email="+encodeURIComponent($("customerEmail").value));
if(!r.found) return alert("Customer not found");
$("customerId").value=r.customer.id;
saveCfg();
alert("Customer loaded");
}catch(e){log(e);}
};

$("fetchJobs").onclick=()=>fetchJobs(false);
$("forceFetch").onclick=()=>fetchJobs(true);

async function fetchJobs(force){
try{
const id=$("customerId").value.trim();
if(!id) return alert("Missing customer ID");
const r=await apiPost(`/customers/${id}/fetch-jobs${force?"?force=true":""}`,{});
log(r);
await loadQueue();
}catch(e){log(e);}
}

async function loadQueue(){
try{
const id=$("customerId").value.trim();
const q=await apiGet(`/customers/${id}/jobs/queue`);
$("queueMeta").textContent=`Loaded ${q.data.length} jobs`;
const tb=$("jobsTbody"); tb.innerHTML="";
q.data.forEach(j=>{
const tr=document.createElement("tr");
tr.innerHTML=`
<td>${j.title||"-"}</td>
<td>${j.company_name||"-"}</td>
<td>${[j.city,j.country].filter(Boolean).join(", ")}</td>
<td><span class="badge">${(j.posted_at||"").slice(0,10)}</span></td>
<td></td>`;
const a=tr.lastElementChild;
const o=document.createElement("button");
o.textContent="Open";
o.onclick=()=>window.open(j.apply_url,"_blank");
const m=document.createElement("button");
m.textContent="Mark applied";
m.onclick=()=>markApplied(j.id);
a.append(o," ",m);
tb.appendChild(tr);
});
}catch(e){log(e);}
}

async function markApplied(jobId){
try{
if(!$("customerId").value||!$("customerEmail").value)
return alert("Customer ID and Email required");
const r=await apiPost("/applications/mark",{
job_id:jobId,
email:$("customerEmail").value,
status:"applied",
applied_by:"team",
application_channel:$("defaultChannel").value,
from_email:$("defaultFromEmail").value||null
});
log(r);
await loadQueue();
}catch(e){log(e);}
}

loadCfg();
</script>
</body>
</html>
